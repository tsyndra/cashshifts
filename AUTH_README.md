# üîê –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ iiko API

## –ö–æ–Ω—Ü–µ–ø—Ü–∏—è

Cash Shifts —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **–ø—Ä—è–º—É—é –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é —á–µ—Ä–µ–∑ iiko API** –≤–º–µ—Å—Ç–æ –ª–æ–∫–∞–ª—å–Ω–æ–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.

## –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

```
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å
   ‚Üì
2. –°–∏—Å—Ç–µ–º–∞ –≤—ã—á–∏—Å–ª—è–µ—Ç SHA1(–ø–∞—Ä–æ–ª—å)
   ‚Üì
3. –ó–∞–ø—Ä–æ—Å –∫ iiko API: /auth?login=username&pass=sha1
   ‚Üì
4. iiko API –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–æ–∫–µ–Ω (–µ—Å–ª–∏ —É—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤–µ—Ä–Ω—ã)
   ‚Üì
5. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω ‚úÖ
   ‚Üì
6. –õ–æ–≥–∏–Ω –∏ SHA1 —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ —Å–µ—Å—Å–∏–∏
   ‚Üì
7. –î–ª—è –≤—Å–µ—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —ç—Ç–∏ –∂–µ –¥–∞–Ω–Ω—ã–µ
```

## –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

‚úÖ **–ù–µ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è** - –æ–¥–∏–Ω –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã (iiko)  
‚úÖ **–ê–≤—Ç–æ—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è** - –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–∞—Ä–æ–ª–µ–π —Å—Ä–∞–∑—É —Ä–∞–±–æ—Ç–∞—é—Ç  
‚úÖ **–ü—Ä–æ—Å—Ç–æ—Ç–∞** - –Ω–µ –Ω—É–∂–Ω–∞ –ª–æ–∫–∞–ª—å–Ω–∞—è –ë–î –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π  
‚úÖ **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å** - –ø–∞—Ä–æ–ª–∏ –Ω–µ —Ö—Ä–∞–Ω—è—Ç—Å—è, —Ç–æ–ª—å–∫–æ SHA1  
‚úÖ **–ï–¥–∏–Ω–∞—è —Ç–æ—á–∫–∞** - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–æ–º –≤ iiko  

## –í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É

–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–≤–æ–∏ —É—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ **iiko**:

```
–õ–æ–≥–∏–Ω: –≤–∞—à_–ª–æ–≥–∏–Ω_–∏–∑_iiko
–ü–∞—Ä–æ–ª—å: –≤–∞—à_–ø–∞—Ä–æ–ª—å_–∏–∑_iiko
```

–ù–∞–ø—Ä–∏–º–µ—Ä, –µ—Å–ª–∏ –≤ iiko —É –≤–∞—Å:
- –õ–æ–≥–∏–Ω: `tsyndra`
- –ü–∞—Ä–æ–ª—å: `We5fb2k93s71!`

–¢–æ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∏—Ö –∂–µ –¥–ª—è –≤—Ö–æ–¥–∞ –≤ Cash Shifts.

## –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –§–∞–π–ª—ã

- **`auth.py`** - –º–æ–¥—É–ª—å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ iiko API
- **`app.py`** - –æ—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (–æ–±–Ω–æ–≤–ª–µ–Ω–æ)
- **`models.py`** - –±–æ–ª—å—à–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è ‚ùå

### –ü—Ä–æ—Ü–µ—Å—Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

1. **Login Route** (`/login`):
   ```python
   success, token, error = authenticate_with_iiko(username, password)
   ```

2. **–§—É–Ω–∫—Ü–∏—è authenticate_with_iiko**:
   - –í—ã—á–∏—Å–ª—è–µ—Ç SHA1 –æ—Ç –ø–∞—Ä–æ–ª—è
   - –î–µ–ª–∞–µ—Ç –∑–∞–ø—Ä–æ—Å –∫ iiko API
   - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç

3. **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ —Å–µ—Å—Å–∏–∏**:
   ```python
   session['username'] = username
   session['password_sha1'] = password_sha1
   ```

4. **–ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤ –¥–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤**:
   ```python
   token = get_token_for_user(username, password_sha1, branch_id)
   ```

### User Loader

```python
@login_manager.user_loader
def load_user(user_id):
    if 'username' in session and 'password_sha1' in session:
        if session['username'] == user_id:
            return User(username=session['username'], 
                       password_sha1=session['password_sha1'])
    return None
```

### User Model

–ü—Ä–æ—Å—Ç–æ–π –∫–ª–∞—Å—Å –±–µ–∑ –ë–î:

```python
class User(UserMixin):
    def __init__(self, username, password_sha1):
        self.id = username
        self.username = username
        self.password_sha1 = password_sha1
```

## –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–æ–º

**–í–æ–ø—Ä–æ—Å:** –ö–∞–∫ –¥–æ–±–∞–≤–∏—Ç—å/—É–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?  
**–û—Ç–≤–µ—Ç:** –ß–µ—Ä–µ–∑ **iiko** - –¥–æ–±–∞–≤—å—Ç–µ/—É–¥–∞–ª–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Ç–∞–º

**–í–æ–ø—Ä–æ—Å:** –ö–∞–∫ –∏–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å?  
**–û—Ç–≤–µ—Ç:** –ß–µ—Ä–µ–∑ **iiko** - –∏–∑–º–µ–Ω–∏—Ç–µ —Ç–∞–º, —Å—Ä–∞–∑—É –∑–∞—Ä–∞–±–æ—Ç–∞–µ—Ç

**–í–æ–ø—Ä–æ—Å:** –ö–∞–∫ –æ–≥—Ä–∞–Ω–∏—á–∏—Ç—å –¥–æ—Å—Ç—É–ø?  
**–û—Ç–≤–µ—Ç:** –ß–µ—Ä–µ–∑ **iiko** - —É–¥–∞–ª–∏—Ç–µ/–¥–µ–∞–∫—Ç–∏–≤–∏—Ä—É–π—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- ‚úÖ –ü–∞—Ä–æ–ª–∏ –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è –≤ –æ—Ç–∫—Ä—ã—Ç–æ–º –≤–∏–¥–µ —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –≤—Ö–æ–¥–µ (HTTPS)
- ‚úÖ –í —Å–µ—Å—Å–∏–∏ —Ö—Ä–∞–Ω–∏—Ç—Å—è —Ç–æ–ª—å–∫–æ SHA1
- ‚úÖ –ö–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å –∫ API –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç–æ–∫–µ–Ω
- ‚úÖ –¢–æ–∫–µ–Ω—ã –≤—Ä–µ–º–µ–Ω–Ω—ã–µ (–ø–æ –ø–æ–ª–∏—Ç–∏–∫–µ iiko)
- ‚úÖ –ù–µ—Ç –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–∞—Ä–æ–ª–µ–π

## –ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å

### –£–¥–∞–ª–µ–Ω–æ

- ‚ùå –õ–æ–∫–∞–ª—å–Ω–∞—è –ë–î –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (`cash_shifts.db`)
- ‚ùå `models.py` (–±–æ–ª—å—à–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)
- ‚ùå –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
- ‚ùå –§—É–Ω–∫—Ü–∏—è `create_admin_user()`
- ‚ùå Routes: `/admin/users/*`

### –î–æ–±–∞–≤–ª–µ–Ω–æ

- ‚úÖ `auth.py` - –º–æ–¥—É–ª—å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ iiko
- ‚úÖ –§—É–Ω–∫—Ü–∏—è `authenticate_with_iiko()`
- ‚úÖ –§—É–Ω–∫—Ü–∏—è `get_token_for_user()`
- ‚úÖ –•—Ä–∞–Ω–µ–Ω–∏–µ —É—á–µ—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –≤ —Å–µ—Å—Å–∏–∏

### –ò–∑–º–µ–Ω–µ–Ω–æ

- üîÑ `/login` - —Ç–µ–ø–µ—Ä—å –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —á–µ—Ä–µ–∑ iiko API
- üîÑ `/logout` - –æ—á–∏—â–∞–µ—Ç —Å–µ—Å—Å–∏—é
- üîÑ `get_user_auth_token()` - –±–µ—Ä–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ —Å–µ—Å—Å–∏–∏
- üîÑ `load_user()` - –∑–∞–≥—Ä—É–∂–∞–µ—Ç –∏–∑ —Å–µ—Å—Å–∏–∏

## –ü—Ä–∏–º–µ—Ä—ã

### –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è

```python
# –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç:
username = "tsyndra"
password = "We5fb2k93s71!"

# –°–∏—Å—Ç–µ–º–∞ –¥–µ–ª–∞–µ—Ç:
success, token, error = authenticate_with_iiko(username, password)

# –ï—Å–ª–∏ success = True:
session['username'] = 'tsyndra'
session['password_sha1'] = 'cb084e5e5f9bfc6cf6c705a382817739c8aebeac'
```

### –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞

```python
# –ü—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –∫ API:
branch_id = "novovatutinskaya"
token = get_token_for_user(
    username=session['username'],
    password_sha1=session['password_sha1'],
    branch_id=branch_id
)

# –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–∫–µ–Ω:
response = requests.get(f"{base_url}/api/...", params={'key': token})
```

## –ú–∏–≥—Ä–∞—Ü–∏—è

–ï—Å–ª–∏ —É –≤–∞—Å –±—ã–ª–∏ –ª–æ–∫–∞–ª—å–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ - –æ–Ω–∏ –±–æ–ª—å—à–µ –Ω–µ –Ω—É–∂–Ω—ã.

–ü—Ä–æ—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —É—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ iiko.

## Troubleshooting

**–ù–µ –º–æ–≥—É –≤–æ–π—Ç–∏:**
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å –≤ iiko
- –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–∫—Ç–∏–≤–µ–Ω –≤ iiko
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å iiko API

**–û—à–∏–±–∫–∞ "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Å–µ—Å—Å–∏–∏":**
- –ü–µ—Ä–µ–∑–∞–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É
- –û—á–∏—Å—Ç–∏—Ç–µ cookies –±—Ä–∞—É–∑–µ—Ä–∞

**–¢–æ–∫–µ–Ω –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
- –í–æ–∑–º–æ–∂–Ω–æ –∏—Å—Ç–µ–∫ —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è
- –ü–µ—Ä–µ–∑–∞–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É

---

**–ü—Ä–æ–¥–∞–∫—à–Ω:** https://cashshifts.tsyndra.ru  
**–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:** AUTH_README.md

