#!/bin/bash

# ะกะบัะธะฟั ะฐะฒัะพะผะฐัะธัะตัะบะพะณะพ ะดะตะฟะปะพั Cash Shifts ะฝะฐ ะฟัะพะดะฐะบัะฝ
# ะัะฟะพะปัะทะพะฒะฐะฝะธะต: ./deploy.sh

set -e  # ะััะฐะฝะพะฒะธัั ะฟัะธ ะพัะธะฑะบะต

echo "๐ ะะฐัะธะฝะฐะตะผ ะดะตะฟะปะพะน Cash Shifts ะฝะฐ ะฟัะพะดะฐะบัะฝ..."

# ะะตัะตัะพะดะธะผ ะฒ ะดะธัะตะบัะพัะธั ะฟัะพะตะบัะฐ
cd /home/workdir/cash_shifts

# ะัะพะฒะตััะตะผ, ััะพ ะผั ะฒ ะฟัะฐะฒะธะปัะฝะพะน ะดะธัะตะบัะพัะธะธ
if [ ! -f "app.py" ]; then
    echo "โ ะัะธะฑะบะฐ: app.py ะฝะต ะฝะฐะนะดะตะฝ. ะฃะฑะตะดะธัะตัั, ััะพ ะฒั ะฒ ะฟัะฐะฒะธะปัะฝะพะน ะดะธัะตะบัะพัะธะธ."
    exit 1
fi

echo "๐ ะขะตะบััะฐั ะดะธัะตะบัะพัะธั: $(pwd)"

# ะััะฐะฝะฐะฒะปะธะฒะฐะตะผ ััะฐััะต ะฟัะพัะตััั app.py
echo "๐ ะััะฐะฝะฐะฒะปะธะฒะฐะตะผ ััะฐััะต ะฟัะพัะตััั..."
pkill -f "python.*app.py" || true
sleep 2

# ะะบัะธะฒะธััะตะผ ะฒะธัััะฐะปัะฝะพะต ะพะบััะถะตะฝะธะต
echo "๐ ะะบัะธะฒะธััะตะผ ะฒะธัััะฐะปัะฝะพะต ะพะบััะถะตะฝะธะต..."
source venv/bin/activate

# ะะฑะฝะพะฒะปัะตะผ ะทะฐะฒะธัะธะผะพััะธ (ะตัะปะธ ะธะทะผะตะฝะธะปะธัั)
echo "๐ฆ ะัะพะฒะตััะตะผ ะทะฐะฒะธัะธะผะพััะธ..."
pip install -r requirements.txt --quiet

# ะัะพะฒะตััะตะผ ัะธะฝัะฐะบัะธั Python
echo "๐ ะัะพะฒะตััะตะผ ัะธะฝัะฐะบัะธั ะฟัะธะปะพะถะตะฝะธั..."
python -m py_compile app.py
python -m py_compile models.py
python -m py_compile main.py
echo "โ ะกะธะฝัะฐะบัะธั ะบะพััะตะบัะตะฝ"

# ะกะพะทะดะฐะตะผ ะฟะฐะฟะบะธ ะตัะปะธ ะฝะต ัััะตััะฒััั
mkdir -p uploads
mkdir -p instance

# ะะฐะฟััะบะฐะตะผ ะฟัะธะปะพะถะตะฝะธะต ะฒ ัะพะฝะต
echo "๐ ะะฐะฟััะบะฐะตะผ ะฟัะธะปะพะถะตะฝะธะต..."
nohup python app.py > app.log 2>&1 &
APP_PID=$!

# ะะดะตะผ ะทะฐะฟััะบะฐ
echo "โณ ะะดะตะผ ะทะฐะฟััะบะฐ ะฟัะธะปะพะถะตะฝะธั..."
sleep 5

# ะัะพะฒะตััะตะผ, ััะพ ะฟัะธะปะพะถะตะฝะธะต ะทะฐะฟัััะธะปะพัั
if ps -p $APP_PID > /dev/null; then
    echo "โ ะัะธะปะพะถะตะฝะธะต ััะฟะตัะฝะพ ะทะฐะฟััะตะฝะพ (PID: $APP_PID)"
    
    # ะัะพะฒะตััะตะผ ะดะพัััะฟะฝะพััั
    if curl -s http://localhost:5000/login > /dev/null; then
        echo "โ ะัะธะปะพะถะตะฝะธะต ะพัะฒะตัะฐะตั ะฝะฐ ะทะฐะฟัะพัั"
    else
        echo "โ๏ธ  ะัะธะปะพะถะตะฝะธะต ะทะฐะฟััะตะฝะพ, ะฝะพ ะฝะต ะพัะฒะตัะฐะตั ะฝะฐ ะทะฐะฟัะพัั"
    fi
else
    echo "โ ะัะธะฑะบะฐ ะทะฐะฟััะบะฐ ะฟัะธะปะพะถะตะฝะธั"
    echo "๐ ะะพะณะธ:"
    tail -20 app.log
    exit 1
fi

echo "๐ ะะตะฟะปะพะน ะทะฐะฒะตััะตะฝ ััะฟะตัะฝะพ!"
echo "๐ ะัะธะปะพะถะตะฝะธะต ะดะพัััะฟะฝะพ ะฟะพ ะฐะดัะตัั: https://cashshifts.tsyndra.ru"
echo "๐ PID ะฟัะพัะตััะฐ: $APP_PID"
echo "๐ ะะพะณะธ: tail -f /home/workdir/cash_shifts/app.log"
